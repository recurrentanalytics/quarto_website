project:
  type: website
  output-dir: _site

website:
  title: "re:current analytics"
  site-url: https://recurrentanalytics.com
  description: "A lab-notebook for climate risk, models, and recurrent intelligence."
  favicon: assets/favicon.svg

  # Social cards (disabled until image exists)
  # image: assets/social-card.png
  open-graph: true
  twitter-card:
    creator: "@timmwalker"
    # image: assets/social-card.png

  navbar:
    logo: assets/favicon.svg
    left:
      - text: Home
        href: index.qmd
      - text: About
        href: about.qmd
      - text: Notes / Lab
        href: notes/
      - text: Projects
        href: projects/
      - text: Models & Tools
        href: models/
      - text: Reading
        href: reading/
      - text: Tipping Points
        href: tipping-points/
      - text: Contact / CV
        href: contact_cv.qmd
    right:
      - icon: github
        href: https://github.com/recurrentanalytics
      - icon: rss
        href: notes/index.xml

  page-footer:
    left: "© Timm Walker"
    right: "A lab for recurrent climate intelligence."

  search: true
  repo-url: https://github.com/recurrentanalytics/recurrentanalytics
  repo-actions: [source]

format:
  html:
    theme:
      light: [cosmo, styles.scss]
      dark:  [cyborg, styles.scss]
    toc: true
    code-tools: true
    code-copy: true
    smooth-scroll: true
    anchor-sections: true
    include-in-header:
      text: |
        <!-- Plausible analytics -->
        <script defer data-domain="recurrentanalytics.com" src="https://plausible.io/js/script.js"></script>
        
        <!-- D3.js for network graph -->
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <!-- Hero drift effect -->
        <style>
          .rac-hero {
            position: relative; padding: 5rem 0 4rem; text-align:center;
            overflow: hidden;
          }
          .rac-hero h1 { font-weight: 800; letter-spacing: .5px; }
          .rac-hero .drift {
            position: absolute; left: -10%; right:-10%; bottom: -40px; height: 120px;
            background: radial-gradient(100% 60% at 50% 40%, var(--bs-secondary-bg) 0%, transparent 70%);
            animation: slowfloat 14s ease-in-out infinite alternate;
            opacity:.7; filter: blur(10px);
          }
          @keyframes slowfloat { from { transform: translateY(0px);} to {transform: translateY(16px);} }
        </style>

        <!-- Reading progress bar, keyboard shortcuts, random note -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Reading progress bar
          const progressBar = document.createElement('div');
          progressBar.className = 'reading-progress';
          document.body.appendChild(progressBar);
          
          window.addEventListener('scroll', function() {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
            progressBar.style.width = progress + '%';
          });

          // Keyboard shortcuts
          const noteLinks = Array.from(document.querySelectorAll('.quarto-listing-default a, .sidebar-item a'));
          let currentIndex = -1;

          document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // / to focus search
            if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
              e.preventDefault();
              const searchInput = document.querySelector('#quarto-search input, .aa-Input');
              if (searchInput) searchInput.focus();
            }
            
            // j/k to navigate notes (on listing pages)
            if (noteLinks.length > 0) {
              if (e.key === 'j') {
                currentIndex = Math.min(currentIndex + 1, noteLinks.length - 1);
                noteLinks[currentIndex]?.focus();
              }
              if (e.key === 'k') {
                currentIndex = Math.max(currentIndex - 1, 0);
                noteLinks[currentIndex]?.focus();
              }
            }
            
            // ? to show keyboard hints
            if (e.key === '?') {
              const hint = document.querySelector('.keyboard-hint');
              if (hint) hint.classList.toggle('visible');
            }
          });

          // Add keyboard hint element
          const hint = document.createElement('div');
          hint.className = 'keyboard-hint';
          hint.innerHTML = '⌘K palette · / search · j/k navigate · ? hints';
          document.body.appendChild(hint);

          // Command Palette (Cmd+K / Ctrl+K)
          const pages = [
            { title: 'Home', path: '/' },
            { title: 'About', path: '/about.html' },
            { title: 'Notes & Knowledge Base', path: '/notes/' },
            { title: 'Projects', path: '/projects/' },
            { title: 'Models & Tools', path: '/models/' },
            { title: 'Reading', path: '/reading/' },
            { title: 'Contact / CV', path: '/contact_cv.html' },
            { title: 'Hello, Lab', path: '/notes/2025-hello-world.html' },
            { title: 'Monte Carlo Basics', path: '/notes/climate/monte-carlo-basics.html' },
            { title: 'SAL', path: '/notes/climate/sal.html' },
            { title: 'Risk Modelling Part 1: Foundations', path: '/notes/risk-series-1.html' },
            { title: 'Risk Modelling Part 2: Data', path: '/notes/risk-series-2.html' },
            { title: 'Risk Modelling Part 3: Implementation', path: '/notes/risk-series-3.html' }
          ];

          const overlay = document.createElement('div');
          overlay.className = 'cmd-palette-overlay';
          overlay.innerHTML = `
            <div class="cmd-palette">
              <input type="text" class="cmd-palette-input" placeholder="Jump to page...">
              <div class="cmd-palette-results"></div>
            </div>
          `;
          document.body.appendChild(overlay);

          const input = overlay.querySelector('.cmd-palette-input');
          const results = overlay.querySelector('.cmd-palette-results');
          let selectedIndex = 0;

          function renderResults(filter = '') {
            const filtered = pages.filter(p => 
              p.title.toLowerCase().includes(filter.toLowerCase())
            );
            results.innerHTML = filtered.map((p, i) => `
              <a href="${p.path}" class="cmd-palette-item ${i === selectedIndex ? 'selected' : ''}">
                <div class="cmd-palette-item-title">${p.title}</div>
                <div class="cmd-palette-item-path">${p.path}</div>
              </a>
            `).join('');
            return filtered;
          }

          function openPalette() {
            overlay.classList.add('active');
            input.value = '';
            selectedIndex = 0;
            renderResults();
            setTimeout(() => input.focus(), 50);
          }

          function closePalette() {
            overlay.classList.remove('active');
          }

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closePalette();
          });

          input.addEventListener('input', () => {
            selectedIndex = 0;
            renderResults(input.value);
          });

          input.addEventListener('keydown', (e) => {
            const items = results.querySelectorAll('.cmd-palette-item');
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
              renderResults(input.value);
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, 0);
              renderResults(input.value);
            } else if (e.key === 'Enter') {
              e.preventDefault();
              if (items[selectedIndex]) items[selectedIndex].click();
            } else if (e.key === 'Escape') {
              closePalette();
            }
          });

          document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
              e.preventDefault();
              if (overlay.classList.contains('active')) {
                closePalette();
              } else {
                openPalette();
              }
            }
            if (e.key === 'Escape' && overlay.classList.contains('active')) {
              closePalette();
            }
          });

          // Reading time - add to article pages
          const articleBody = document.querySelector('.quarto-title-block, #quarto-document-content');
          const contentArea = document.querySelector('#quarto-document-content, .content, main');
          if (articleBody && contentArea) {
            const text = contentArea.innerText || '';
            const wordCount = text.trim().split(/\s+/).length;
            const readingTime = Math.max(1, Math.ceil(wordCount / 200));
            const timeSpan = document.createElement('span');
            timeSpan.className = 'reading-time';
            timeSpan.textContent = readingTime + ' min read';
            const titleMeta = document.querySelector('.quarto-title-meta, .quarto-title');
            if (titleMeta) {
              titleMeta.appendChild(document.createTextNode(' · '));
              titleMeta.appendChild(timeSpan);
            }
          }

          // Random note link - add to footer if on notes section
          const notesData = [
            '/notes/2025-hello-world.html',
            '/notes/climate/monte-carlo-basics.html',
            '/notes/climate/sal.html',
            '/notes/risk-series-1.html',
            '/notes/risk-series-2.html',
            '/notes/risk-series-3.html'
          ];
          
          const footer = document.querySelector('.nav-footer-center, .nav-footer-right');
          if (footer && notesData.length > 0) {
            const randomLink = document.createElement('a');
            randomLink.href = '#';
            randomLink.className = 'random-note-link';
            randomLink.textContent = '↻ Random note';
            randomLink.addEventListener('click', function(e) {
              e.preventDefault();
              const randomNote = notesData[Math.floor(Math.random() * notesData.length)];
              window.location.href = randomNote;
            });
            footer.appendChild(document.createTextNode(' · '));
            footer.appendChild(randomLink);
          }

          // Network Graph - Obsidian-style visualization
          const graphData = {
            nodes: [
              { id: 'home', label: 'Home', path: '/' },
              { id: 'about', label: 'About', path: '/about.html' },
              { id: 'notes', label: 'Notes', path: '/notes/' },
              { id: 'hello', label: 'Hello, Lab', path: '/notes/2025-hello-world.html' },
              { id: 'monte-carlo', label: 'Monte Carlo', path: '/notes/climate/monte-carlo-basics.html' },
              { id: 'sal', label: 'SAL', path: '/notes/climate/sal.html' },
              { id: 'risk-1', label: 'Risk Part 1', path: '/notes/risk-series-1.html' },
              { id: 'risk-2', label: 'Risk Part 2', path: '/notes/risk-series-2.html' },
              { id: 'risk-3', label: 'Risk Part 3', path: '/notes/risk-series-3.html' },
              { id: 'era5', label: 'ERA5 Demo', path: '/models/era5-demo.html' },
              { id: 'projects', label: 'Projects', path: '/projects/' },
              { id: 'models', label: 'Models', path: '/models/' },
              { id: 'reading', label: 'Reading', path: '/reading/' },
              { id: 'contact', label: 'Contact', path: '/contact_cv.html' }
            ],
            links: [
              { source: 'home', target: 'notes' },
              { source: 'home', target: 'projects' },
              { source: 'home', target: 'models' },
              { source: 'home', target: 'about' },
              { source: 'notes', target: 'hello' },
              { source: 'notes', target: 'monte-carlo' },
              { source: 'notes', target: 'sal' },
              { source: 'notes', target: 'risk-1' },
              { source: 'risk-1', target: 'monte-carlo' },
              { source: 'risk-1', target: 'risk-2' },
              { source: 'risk-2', target: 'risk-1' },
              { source: 'risk-2', target: 'risk-3' },
              { source: 'risk-2', target: 'sal' },
              { source: 'risk-2', target: 'era5' },
              { source: 'risk-3', target: 'risk-1' },
              { source: 'risk-3', target: 'risk-2' },
              { source: 'risk-3', target: 'monte-carlo' },
              { source: 'risk-3', target: 'sal' },
              { source: 'models', target: 'era5' }
            ]
          };

          // Create graph button
          const graphBtn = document.createElement('button');
          graphBtn.className = 'graph-btn';
          graphBtn.title = 'View note connections';
          graphBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="6" r="2"/><circle cx="12" cy="4" r="2"/><circle cx="19" cy="8" r="2"/><circle cx="6" cy="18" r="2"/><circle cx="18" cy="18" r="2"/><line x1="7" y1="6" x2="10" y2="5"/><line x1="14" y1="5" x2="17" y2="7"/><line x1="6" y1="8" x2="6" y2="16"/><line x1="18" y1="10" x2="18" y2="16"/><line x1="8" y1="17" x2="16" y2="17"/></svg>';
          document.body.appendChild(graphBtn);

          // Create modal
          const graphModal = document.createElement('div');
          graphModal.className = 'graph-modal-overlay';
          graphModal.innerHTML = `
            <div class="graph-modal">
              <div class="graph-modal-header">
                <span class="graph-modal-title">Note Connections</span>
                <button class="graph-modal-close">&times;</button>
              </div>
              <div class="graph-container" id="graph-container"></div>
            </div>
          `;
          document.body.appendChild(graphModal);

          function getCurrentPageId() {
            const path = window.location.pathname;
            const node = graphData.nodes.find(n => path.endsWith(n.path) || path === n.path || 
              (n.path === '/' && (path === '/' || path === '/index.html' || path.endsWith('/index.html'))));
            return node ? node.id : null;
          }

          function openGraph() {
            graphModal.classList.add('active');
            initGraph();
          }

          function closeGraph() {
            graphModal.classList.remove('active');
          }

          graphBtn.addEventListener('click', openGraph);
          graphModal.querySelector('.graph-modal-close').addEventListener('click', closeGraph);
          graphModal.addEventListener('click', (e) => {
            if (e.target === graphModal) closeGraph();
          });
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && graphModal.classList.contains('active')) closeGraph();
            if (e.key === 'g' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
              openGraph();
            }
          });

          let graphInitialized = false;
          function initGraph() {
            if (graphInitialized) return;
            graphInitialized = true;

            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const currentId = getCurrentPageId();

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            container.appendChild(svg);

            const nodes = graphData.nodes.map(d => ({...d}));
            const links = graphData.links.map(d => ({...d}));

            const connectedNodes = new Set();
            links.forEach(l => {
              if (l.source === currentId || l.target === currentId) {
                connectedNodes.add(l.source);
                connectedNodes.add(l.target);
              }
            });

            // Simple force simulation without D3
            nodes.forEach((n, i) => {
              const angle = (i / nodes.length) * 2 * Math.PI;
              const radius = 150;
              n.x = width / 2 + radius * Math.cos(angle);
              n.y = height / 2 + radius * Math.sin(angle);
              n.vx = 0;
              n.vy = 0;
            });

            const nodeMap = {};
            nodes.forEach(n => nodeMap[n.id] = n);

            function simulate() {
              const centerX = width / 2;
              const centerY = height / 2;

              nodes.forEach(n => {
                n.vx += (centerX - n.x) * 0.003;
                n.vy += (centerY - n.y) * 0.003;
              });

              for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                  const dx = nodes[j].x - nodes[i].x;
                  const dy = nodes[j].y - nodes[i].y;
                  const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                  const force = 800 / (dist * dist);
                  const fx = (dx / dist) * force;
                  const fy = (dy / dist) * force;
                  nodes[i].vx -= fx;
                  nodes[i].vy -= fy;
                  nodes[j].vx += fx;
                  nodes[j].vy += fy;
                }
              }

              links.forEach(l => {
                const source = nodeMap[l.source] || nodeMap[l.source.id];
                const target = nodeMap[l.target] || nodeMap[l.target.id];
                if (!source || !target) return;
                const dx = target.x - source.x;
                const dy = target.y - source.y;
                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                const force = (dist - 100) * 0.02;
                const fx = (dx / dist) * force;
                const fy = (dy / dist) * force;
                source.vx += fx;
                source.vy += fy;
                target.vx -= fx;
                target.vy -= fy;
              });

              nodes.forEach(n => {
                n.vx *= 0.85;
                n.vy *= 0.85;
                n.x += n.vx;
                n.y += n.vy;
                n.x = Math.max(40, Math.min(width - 40, n.x));
                n.y = Math.max(40, Math.min(height - 40, n.y));
              });
            }

            for (let i = 0; i < 100; i++) simulate();

            // Draw links
            links.forEach(l => {
              const source = nodeMap[l.source] || nodeMap[l.source.id];
              const target = nodeMap[l.target] || nodeMap[l.target.id];
              if (!source || !target) return;
              const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
              line.setAttribute('x1', source.x);
              line.setAttribute('y1', source.y);
              line.setAttribute('x2', target.x);
              line.setAttribute('y2', target.y);
              line.setAttribute('class', 'graph-link' + (connectedNodes.has(l.source) && connectedNodes.has(l.target) ? ' connected' : ''));
              svg.appendChild(line);
            });

            // Draw nodes
            nodes.forEach(n => {
              const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
              g.setAttribute('class', 'graph-node' + (n.id === currentId ? ' current' : ''));
              g.setAttribute('transform', `translate(${n.x},${n.y})`);

              const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
              const isConnected = connectedNodes.has(n.id);
              circle.setAttribute('r', n.id === currentId ? 10 : (isConnected ? 8 : 6));
              circle.setAttribute('fill', n.id === currentId ? 'var(--bs-primary)' : (isConnected ? 'var(--bs-info)' : 'var(--bs-secondary)'));
              g.appendChild(circle);

              const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
              text.setAttribute('y', 20);
              text.textContent = n.label;
              g.appendChild(text);

              g.style.cursor = 'pointer';
              g.addEventListener('click', () => {
                window.location.href = n.path;
              });

              svg.appendChild(g);
            });
          }
        });
        </script>

execute:
  freeze: auto

# Blog-style collection with feed (RSS at notes/index.xml)
collections:
  notes:
    feed: true
    categories: true
    sort: "date desc"
    listing:
      type: default
      sort: "date desc"
      contents: "notes/*"
