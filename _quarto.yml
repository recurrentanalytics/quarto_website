project:
  type: website
  output-dir: _site

website:
  title: "re:current analytics"
  site-url: https://recurrentanalytics.com
  description: "A lab-notebook for climate risk, models, and recurrent intelligence."
  favicon: assets/favicon.svg

  # Social cards (disabled until image exists)
  # image: assets/social-card.png
  open-graph: true
  twitter-card:
    creator: "@timmwalker"
    # image: assets/social-card.png

  navbar:
    logo: assets/favicon.svg
    left:
      - text: Home
        href: index.qmd
      - text: About
        href: about.qmd
      - text: Notes / Lab
        href: notes/
      - text: Projects
        href: projects/
      - text: Models & Tools
        href: models/
      - text: Reading
        href: reading/
      - text: Tipping Points
        href: tipping-points/
      - text: Contact / CV
        href: contact_cv.qmd
    right:
      - icon: github
        href: https://github.com/recurrentanalytics
      - icon: rss
        href: notes/index.xml

  page-footer:
    left: "© Timm Walker"
    right: "A lab for recurrent climate intelligence."

  search: true
  repo-url: https://github.com/recurrentanalytics/recurrentanalytics
  repo-actions: [source]

format:
  html:
    theme:
      light: [cosmo, styles.scss]
      dark:  [cyborg, styles.scss]
    toc: true
    code-tools: true
    code-copy: true
    smooth-scroll: true
    anchor-sections: true
    include-in-header:
      text: |
        <!-- Plausible analytics -->
        <script defer data-domain="recurrentanalytics.com" src="https://plausible.io/js/script.js"></script>
        
        <!-- D3.js for network graph -->
        <script src="https://d3js.org/d3.v7.min.js"></script>

        <!-- Hero drift effect -->
        <style>
          .rac-hero {
            position: relative; padding: 5rem 0 4rem; text-align:center;
            overflow: hidden;
          }
          .rac-hero h1 { font-weight: 800; letter-spacing: .5px; }
          .rac-hero .drift {
            position: absolute; left: -10%; right:-10%; bottom: -40px; height: 120px;
            background: radial-gradient(100% 60% at 50% 40%, var(--bs-secondary-bg) 0%, transparent 70%);
            animation: slowfloat 14s ease-in-out infinite alternate;
            opacity:.7; filter: blur(10px);
          }
          @keyframes slowfloat { from { transform: translateY(0px);} to {transform: translateY(16px);} }
        </style>

        <!-- Reading progress bar, keyboard shortcuts, random note -->
        <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Reading progress bar
          const progressBar = document.createElement('div');
          progressBar.className = 'reading-progress';
          document.body.appendChild(progressBar);
          
          window.addEventListener('scroll', function() {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
            progressBar.style.width = progress + '%';
          });

          // Keyboard shortcuts
          const noteLinks = Array.from(document.querySelectorAll('.quarto-listing-default a, .sidebar-item a'));
          let currentIndex = -1;

          document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // / to focus search
            if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
              e.preventDefault();
              const searchInput = document.querySelector('#quarto-search input, .aa-Input');
              if (searchInput) searchInput.focus();
            }
            
            // j/k to navigate notes (on listing pages)
            if (noteLinks.length > 0) {
              if (e.key === 'j') {
                currentIndex = Math.min(currentIndex + 1, noteLinks.length - 1);
                noteLinks[currentIndex]?.focus();
              }
              if (e.key === 'k') {
                currentIndex = Math.max(currentIndex - 1, 0);
                noteLinks[currentIndex]?.focus();
              }
            }
            
            // ? to show keyboard hints
            if (e.key === '?') {
              const hint = document.querySelector('.keyboard-hint');
              if (hint) hint.classList.toggle('visible');
            }
          });

          // Add keyboard hint element
          const hint = document.createElement('div');
          hint.className = 'keyboard-hint';
          hint.innerHTML = '⌘K palette · / search · j/k navigate · ? hints';
          document.body.appendChild(hint);

          // Command Palette (Cmd+K / Ctrl+K)
          const pages = [
            { title: 'Home', path: '/' },
            { title: 'About', path: '/about.html' },
            { title: 'Notes & Knowledge Base', path: '/notes/' },
            { title: 'Projects', path: '/projects/' },
            { title: 'Models & Tools', path: '/models/' },
            { title: 'Reading', path: '/reading/' },
            { title: 'Contact / CV', path: '/contact_cv.html' },
            { title: 'Hello, Lab', path: '/notes/2025-hello-world.html' },
            { title: 'Monte Carlo Basics', path: '/notes/climate/monte-carlo-basics.html' },
            { title: 'SAL', path: '/notes/climate/sal.html' },
            { title: 'Risk Modelling Part 1: Foundations', path: '/notes/risk-series-1.html' },
            { title: 'Risk Modelling Part 2: Data', path: '/notes/risk-series-2.html' },
            { title: 'Risk Modelling Part 3: Implementation', path: '/notes/risk-series-3.html' }
          ];

          const overlay = document.createElement('div');
          overlay.className = 'cmd-palette-overlay';
          overlay.innerHTML = `
            <div class="cmd-palette">
              <input type="text" class="cmd-palette-input" placeholder="Jump to page...">
              <div class="cmd-palette-results"></div>
            </div>
          `;
          document.body.appendChild(overlay);

          const input = overlay.querySelector('.cmd-palette-input');
          const results = overlay.querySelector('.cmd-palette-results');
          let selectedIndex = 0;

          function renderResults(filter = '') {
            const filtered = pages.filter(p => 
              p.title.toLowerCase().includes(filter.toLowerCase())
            );
            results.innerHTML = filtered.map((p, i) => `
              <a href="${p.path}" class="cmd-palette-item ${i === selectedIndex ? 'selected' : ''}">
                <div class="cmd-palette-item-title">${p.title}</div>
                <div class="cmd-palette-item-path">${p.path}</div>
              </a>
            `).join('');
            return filtered;
          }

          function openPalette() {
            overlay.classList.add('active');
            input.value = '';
            selectedIndex = 0;
            renderResults();
            setTimeout(() => input.focus(), 50);
          }

          function closePalette() {
            overlay.classList.remove('active');
          }

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closePalette();
          });

          input.addEventListener('input', () => {
            selectedIndex = 0;
            renderResults(input.value);
          });

          input.addEventListener('keydown', (e) => {
            const items = results.querySelectorAll('.cmd-palette-item');
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
              renderResults(input.value);
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, 0);
              renderResults(input.value);
            } else if (e.key === 'Enter') {
              e.preventDefault();
              if (items[selectedIndex]) items[selectedIndex].click();
            } else if (e.key === 'Escape') {
              closePalette();
            }
          });

          document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
              e.preventDefault();
              if (overlay.classList.contains('active')) {
                closePalette();
              } else {
                openPalette();
              }
            }
            if (e.key === 'Escape' && overlay.classList.contains('active')) {
              closePalette();
            }
          });

          // Reading time - add to article pages
          const articleBody = document.querySelector('.quarto-title-block, #quarto-document-content');
          const contentArea = document.querySelector('#quarto-document-content, .content, main');
          if (articleBody && contentArea) {
            const text = contentArea.innerText || '';
            const wordCount = text.trim().split(/\s+/).length;
            const readingTime = Math.max(1, Math.ceil(wordCount / 200));
            const timeSpan = document.createElement('span');
            timeSpan.className = 'reading-time';
            timeSpan.textContent = readingTime + ' min read';
            const titleMeta = document.querySelector('.quarto-title-meta, .quarto-title');
            if (titleMeta) {
              titleMeta.appendChild(document.createTextNode(' · '));
              titleMeta.appendChild(timeSpan);
            }
          }

          // Random note link - add to footer if on notes section
          const notesData = [
            '/notes/2025-hello-world.html',
            '/notes/climate/monte-carlo-basics.html',
            '/notes/climate/sal.html',
            '/notes/risk-series-1.html',
            '/notes/risk-series-2.html',
            '/notes/risk-series-3.html'
          ];
          
          const footer = document.querySelector('.nav-footer-center, .nav-footer-right');
          if (footer && notesData.length > 0) {
            const randomLink = document.createElement('a');
            randomLink.href = '#';
            randomLink.className = 'random-note-link';
            randomLink.textContent = '↻ Random note';
            randomLink.addEventListener('click', function(e) {
              e.preventDefault();
              const randomNote = notesData[Math.floor(Math.random() * notesData.length)];
              window.location.href = randomNote;
            });
            footer.appendChild(document.createTextNode(' · '));
            footer.appendChild(randomLink);
          }

          // Network Graph - Obsidian-style visualization
          const graphData = {
            nodes: [
              { id: 'home', label: 'Home', path: '/' },
              { id: 'about', label: 'About', path: '/about.html' },
              { id: 'notes', label: 'Notes', path: '/notes/' },
              { id: 'hello', label: 'Hello, Lab', path: '/notes/2025-hello-world.html' },
              { id: 'monte-carlo', label: 'Monte Carlo', path: '/notes/climate/monte-carlo-basics.html' },
              { id: 'sal', label: 'SAL', path: '/notes/climate/sal.html' },
              { id: 'risk-1', label: 'Risk Part 1', path: '/notes/risk-series-1.html' },
              { id: 'risk-2', label: 'Risk Part 2', path: '/notes/risk-series-2.html' },
              { id: 'risk-3', label: 'Risk Part 3', path: '/notes/risk-series-3.html' },
              { id: 'era5', label: 'ERA5 Demo', path: '/models/era5-demo.html' },
              { id: 'projects', label: 'Projects', path: '/projects/' },
              { id: 'models', label: 'Models', path: '/models/' },
              { id: 'reading', label: 'Reading', path: '/reading/' },
              { id: 'contact', label: 'Contact', path: '/contact_cv.html' }
            ],
            links: [
              { source: 'home', target: 'notes' },
              { source: 'home', target: 'projects' },
              { source: 'home', target: 'models' },
              { source: 'home', target: 'about' },
              { source: 'notes', target: 'hello' },
              { source: 'notes', target: 'monte-carlo' },
              { source: 'notes', target: 'sal' },
              { source: 'notes', target: 'risk-1' },
              { source: 'risk-1', target: 'monte-carlo' },
              { source: 'risk-1', target: 'risk-2' },
              { source: 'risk-2', target: 'risk-1' },
              { source: 'risk-2', target: 'risk-3' },
              { source: 'risk-2', target: 'sal' },
              { source: 'risk-2', target: 'era5' },
              { source: 'risk-3', target: 'risk-1' },
              { source: 'risk-3', target: 'risk-2' },
              { source: 'risk-3', target: 'monte-carlo' },
              { source: 'risk-3', target: 'sal' },
              { source: 'models', target: 'era5' }
            ]
          };

          // Create sidebar mini-graph widget
          const sidebar = document.querySelector('#quarto-margin-sidebar, .sidebar, #TOC');
          const sidebarGraph = document.createElement('div');
          sidebarGraph.className = 'sidebar-graph';
          sidebarGraph.title = 'Click to expand';
          sidebarGraph.innerHTML = `
            <div class="sidebar-graph-header">
              <span class="sidebar-graph-title">Connections</span>
              <span class="sidebar-graph-expand">expand</span>
            </div>
            <div class="sidebar-graph-container" id="mini-graph-container"></div>
          `;
          if (sidebar) {
            sidebar.appendChild(sidebarGraph);
          } else {
            document.body.appendChild(sidebarGraph);
            sidebarGraph.style.position = 'fixed';
            sidebarGraph.style.bottom = '1rem';
            sidebarGraph.style.right = '1rem';
            sidebarGraph.style.width = '200px';
            sidebarGraph.style.zIndex = '100';
          }

          // Create modal
          const graphModal = document.createElement('div');
          graphModal.className = 'graph-modal-overlay';
          graphModal.innerHTML = `
            <div class="graph-modal">
              <div class="graph-modal-header">
                <span class="graph-modal-title">Note Connections</span>
                <button class="graph-modal-close">&times;</button>
              </div>
              <div class="graph-container" id="graph-container"></div>
            </div>
          `;
          document.body.appendChild(graphModal);

          function getCurrentPageId() {
            const path = window.location.pathname;
            const node = graphData.nodes.find(n => path.endsWith(n.path) || path === n.path || 
              (n.path === '/' && (path === '/' || path === '/index.html' || path.endsWith('/index.html'))));
            return node ? node.id : null;
          }

          function openGraph() {
            graphModal.classList.add('active');
            initGraph();
          }

          function closeGraph() {
            graphModal.classList.remove('active');
          }

          sidebarGraph.addEventListener('click', openGraph);
          graphModal.querySelector('.graph-modal-close').addEventListener('click', closeGraph);
          graphModal.addEventListener('click', (e) => {
            if (e.target === graphModal) closeGraph();
          });
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && graphModal.classList.contains('active')) closeGraph();
            if (e.key === 'g' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
              openGraph();
            }
          });

          // Render mini-graph in sidebar immediately using D3-force
          function renderMiniGraph() {
            const container = document.getElementById('mini-graph-container');
            if (!container || typeof d3 === 'undefined') return;
            
            const width = container.clientWidth || 180;
            const height = container.clientHeight || 150;
            const currentId = getCurrentPageId();

            const svg = d3.select(container).append('svg')
              .attr('viewBox', `0 0 ${width} ${height}`);

            const nodes = graphData.nodes.map(d => ({...d}));
            const links = graphData.links.map(d => ({source: d.source, target: d.target}));

            const connectedNodes = new Set();
            graphData.links.forEach(l => {
              if (l.source === currentId || l.target === currentId) {
                connectedNodes.add(l.source);
                connectedNodes.add(l.target);
              }
            });

            // D3 force simulation for mini graph
            const simulation = d3.forceSimulation(nodes)
              .force('link', d3.forceLink(links).id(d => d.id).distance(30))
              .force('charge', d3.forceManyBody().strength(-60))
              .force('center', d3.forceCenter(width / 2, height / 2))
              .force('collision', d3.forceCollide().radius(10))
              .stop();

            // Run simulation synchronously for static layout
            for (let i = 0; i < 100; i++) simulation.tick();

            // Clamp positions
            nodes.forEach(n => {
              n.x = Math.max(15, Math.min(width - 15, n.x));
              n.y = Math.max(15, Math.min(height - 15, n.y));
            });

            // Draw links
            svg.selectAll('line')
              .data(links)
              .join('line')
              .attr('x1', d => d.source.x)
              .attr('y1', d => d.source.y)
              .attr('x2', d => d.target.x)
              .attr('y2', d => d.target.y)
              .attr('class', d => 'graph-link' + (connectedNodes.has(d.source.id) && connectedNodes.has(d.target.id) ? ' connected' : ''));

            // Draw nodes (no labels for compact view)
            svg.selectAll('circle')
              .data(nodes)
              .join('circle')
              .attr('cx', d => d.x)
              .attr('cy', d => d.y)
              .attr('r', d => d.id === currentId ? 6 : (connectedNodes.has(d.id) ? 4 : 3))
              .attr('fill', d => d.id === currentId ? 'var(--bs-primary)' : (connectedNodes.has(d.id) ? 'var(--bs-info)' : 'var(--bs-secondary)'))
              .attr('class', d => 'graph-node' + (d.id === currentId ? ' current' : ''));
          }
          
          renderMiniGraph();

          let graphInitialized = false;
          function initGraph() {
            if (graphInitialized || typeof d3 === 'undefined') return;
            graphInitialized = true;

            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const currentId = getCurrentPageId();

            const svg = d3.select(container).append('svg')
              .attr('viewBox', `0 0 ${width} ${height}`);

            const nodes = graphData.nodes.map(d => ({...d}));
            const links = graphData.links.map(d => ({source: d.source, target: d.target}));

            const connectedNodes = new Set();
            graphData.links.forEach(l => {
              if (l.source === currentId || l.target === currentId) {
                connectedNodes.add(l.source);
                connectedNodes.add(l.target);
              }
            });

            // D3 force simulation for full graph
            const simulation = d3.forceSimulation(nodes)
              .force('link', d3.forceLink(links).id(d => d.id).distance(80))
              .force('charge', d3.forceManyBody().strength(-200))
              .force('center', d3.forceCenter(width / 2, height / 2))
              .force('collision', d3.forceCollide().radius(25))
              .stop();

            // Run simulation synchronously
            for (let i = 0; i < 150; i++) simulation.tick();

            // Clamp positions
            nodes.forEach(n => {
              n.x = Math.max(50, Math.min(width - 50, n.x));
              n.y = Math.max(50, Math.min(height - 50, n.y));
            });

            // Draw links
            svg.selectAll('line')
              .data(links)
              .join('line')
              .attr('x1', d => d.source.x)
              .attr('y1', d => d.source.y)
              .attr('x2', d => d.target.x)
              .attr('y2', d => d.target.y)
              .attr('class', d => 'graph-link' + (connectedNodes.has(d.source.id) && connectedNodes.has(d.target.id) ? ' connected' : ''));

            // Draw nodes with labels
            const nodeGroups = svg.selectAll('g.graph-node')
              .data(nodes)
              .join('g')
              .attr('class', d => 'graph-node' + (d.id === currentId ? ' current' : ''))
              .attr('transform', d => `translate(${d.x},${d.y})`)
              .style('cursor', 'pointer')
              .on('click', (event, d) => { window.location.href = d.path; });

            nodeGroups.append('circle')
              .attr('r', d => d.id === currentId ? 10 : (connectedNodes.has(d.id) ? 8 : 6))
              .attr('fill', d => d.id === currentId ? 'var(--bs-primary)' : (connectedNodes.has(d.id) ? 'var(--bs-info)' : 'var(--bs-secondary)'));

            nodeGroups.append('text')
              .attr('y', 20)
              .text(d => d.label);
          }
        });
        </script>

execute:
  freeze: auto

# Blog-style collection with feed (RSS at notes/index.xml)
collections:
  notes:
    feed: true
    categories: true
    sort: "date desc"
    listing:
      type: default
      sort: "date desc"
      contents: "notes/*"
